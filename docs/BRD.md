# 业务需求文档（BRD）

## 1. 背景与目标

### 1.1 背景

电商/内容团队在小红书做种草与投放时，常见问题：
- “图像生成”容易把产品细节（Logo/包装文字/关键结构）改坏，导致不可用。
- 复刻爆款笔记时，原稿采集、洗稿、配图仿写流程割裂，效率低、不可追溯。

### 1.2 产品目标

构建一套工作台，提供：
1. **原稿采集**：输入小红书链接/分享文案，提取标题、正文、原稿插图。
2. **洗稿生成**：基于原稿全文输出同量级的新文案（结构、字数、标签等可控）。
3. **配图仿写**：基于原稿插图生成“像同一账号发的另一套图”，同时保持产品像素级保真（不丢 Logo/包装文字）。
4. **高保真换背景**：输入产品图与参考图，输出风格一致的新图，产品主体像素级保真。
5. **批量 Flow**：同一产品图批量匹配多张参考图，异步生成与进度可查询。

## 2. 用户画像与使用场景

### 2.1 用户画像

- 电商运营：需要大量“看起来真实”的 UGC 图文素材
- 内容运营：要快速产出多版本文案与配图
- 投放素材制作：要高产、可复用、可追溯的产出链路

### 2.2 典型场景

- 输入一条竞品/爆款笔记链接，快速拿到原稿图文，生成自己的“同字数级”新稿并配套 B 图。
- 输入产品图与多张参考图，批量生成不同风格的高保真展示图，统一落盘便于投放。

## 3. 需求范围（MVP / P0 / P1）

### 3.1 P0（当前核心）

- 洗稿工作台：采集原稿 -> 洗稿 -> 配图仿写
- 高保真换背景：`generate`
- 批量 Flow：`flow/start` + `flow/status`

### 3.2 P1（路线图）

- 账号体系/权限
- 任务队列与重试（持久化）
- 素材库（原稿、产物、模板、版本）
- 审计与风控（敏感词/合规检查）
- 计费/配额

## 4. 业务流程（以当前 Streamlit UI 为准）

### 4.1 洗稿工作台

1. 用户粘贴小红书链接/分享文案
2. 点击“采集原稿”
   - 若登录态失效：弹出浏览器窗口提示用户完成登录/同意
   - 成功后：展示“原稿插图”与“原稿全文”
3. 点击“生成洗稿”
   - 输出新标题、正文、要点、标签等
4. 点击“生成图片”
   - 输出 B-中等 / B-激进 两列对比图
   - 产物目录可追溯（runs/task_id）

### 4.2 高保真换背景（API）

1. 上传产品图 + 参考图
2. 返回产物 URL（`/runs/<task_id>/final.png`）

### 4.3 批量 Flow（API）

1. 上传产品图 + 多张参考图
2. 返回 `flow_id`
3. 轮询 `flow/status/{flow_id}` 获取进度与产物

## 5. 功能需求（FR）

### 5.1 原稿采集（XHS）

- 输入：小红书链接或分享文案（可能包含多 URL）
- 输出：
  - 标题（去掉 `- 小红书/｜小红书` 等尾巴）
  - 正文（去重、去掉“发布时间”等无关字段）
  - 原稿插图 URL 列表
- 登录策略：
  - 若 cookie/profile 过期：按需弹窗让用户登录/同意，记录登录态（profile + cookie 落盘），后续无需重复登录。
- 错误提示：
  - 401：被登录/协议页拦截（需要用户在弹窗完成）
  - 409：窗口被关闭/上下文失效
  - 429：风控 300012/IP 风险（提示换网络）
  - 404：页面不存在（或风控伪装）

### 5.2 洗稿生成

- 输入：原稿全文（允许用户手工编辑）
- 输出：
  - 标题、正文
  - 大纲/要点（可用于配图 prompt）
  - 标签（hashtags）
  - 字数统计：`word_count` 与 `target_word_count`（尽可能对齐原稿规模）

### 5.3 配图仿写（B 图）

- 输入：原稿插图列表（与原稿数量一致）
- 输出：
  - B-中等与 B-激进两套结果（用于对比与挑选）
  - 产物落盘到 runs 目录，并可通过 URL 访问
- 约束：
  - **不叠加文字**（不做标题栏/字幕/水印）
  - 场景要合理：避免不合常理/不安全场景组合（例如地铁里摆拍酒精饮品）
  - 产品保真（默认）：**背景局部改写（mask edit）**，尽量锁死主体/产品，仅改背景与道具；并在产品区域做“细节保真”增强，减少贴图感与文字失真。
  - 比例稳定：对激进结果做占比 gate，漂移过大自动降强度重试/回退，避免产品突然变大/变小

### 5.4 高保真换背景

- 输入：产品图 + 参考图
- 输出：背景风格拟合参考图、产品主体像素级保真
- 若产品图无 alpha：自动调用 matting sidecar 抠图

### 5.5 批量 Flow

- 输入：单个产品图 + 多参考图
- 输出：每个参考图对应的 runs 产物
- 状态：processing/completed/partial_failed/failed/cancelled

## 6. 非功能需求（NFR）

### 6.1 性能

- 单次采集：允许 10~120 秒（受风控/登录影响）
- 单张生成：受 GPU/模型影响，允许数十秒到数分钟
- 批量：支持并发（当前线程池 workers 由环境变量控制）

### 6.2 可靠性

- 采集有风控不确定性：需要明确错误码与兜底方案（relay / 手工复制）
- 生成任务失败需要可定位：trace_id 阶段日志

### 6.3 安全

- `.env` 中可能包含 cookie 与 API key：禁止提交、避免日志泄露、最小权限

## 7. 验收标准（示例用例）

- 用例 A：未登录 profile 时采集
  - 点击采集，弹出浏览器，登录后同一次请求完成采集
  - 成功后 `.env` 的 `XHS_COOKIE` 被更新
- 用例 B：风控 300012
  - 返回 429，提示换网络，不进入登录等待
- 用例 C：局域网访问前端
  - 其他电脑访问 `http://<server-ip>:8501`，原稿插图与生成图正常显示
- 用例 D：生成图片无文字叠加
  - 输出图中不出现额外标题栏/字幕/水印（包装自带文字允许存在）

## 8. 风险与对策

- 小红书风控不可控：
  - 对策：持久化 profile + cookie；必要时使用 relay；为用户提供明确错误码与操作指引。
- 依赖兼容性：
  - 对策：matting 拆 sidecar（Python 3.11）；部署文档明确推荐版本与替代方案。
- 产物磁盘占用：
  - 对策：runs 目录定期清理策略（后续可做自动清理/归档）。
